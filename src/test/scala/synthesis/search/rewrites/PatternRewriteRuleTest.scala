package synthesis.search.rewrites

import org.scalatest.{FunSuite, Matchers}
import structures.mutable.VocabularyHyperGraph
import structures.{EmptyMetadata, HyperEdge, mutable}
import synthesis.search.rewrites.Template.{ExplicitTerm, TemplateTerm}
import synthesis.{HyperTermId, HyperTermIdentifier, Programs}
import transcallang.Identifier

class PatternRewriteRuleTest extends FunSuite with Matchers {

  test("testApply adds edges") {
    val conditions = VocabularyHyperGraph[TemplateTerm[HyperTermId], TemplateTerm[HyperTermIdentifier]](HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("8"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("1"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("47"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("23"))),Vector(ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("21"))),Vector(ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("38"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("8"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("19"))),Vector(),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("25"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("45"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("0"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("12"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("35"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("36"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata))
    val destinations = VocabularyHyperGraph[TemplateTerm[HyperTermId], TemplateTerm[HyperTermIdentifier]](HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("23"))),Vector(),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("36"))),Vector(ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("28"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("32"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("48"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("23"))),Vector(ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("23"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("13"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("46"))),Vector(),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("40"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("45"))),Vector(),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("38"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("25"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("28"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("32"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("23"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("26"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("41"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("5"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("35"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("50"))),Vector(ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("37"))),Vector(ExplicitTerm(HyperTermId(50))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("0"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("25"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("6"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(50)),ExplicitTerm(HyperTermIdentifier(Identifier("7"))),Vector(ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata), HyperEdge(ExplicitTerm(HyperTermId(1)),ExplicitTerm(HyperTermIdentifier(Identifier("45"))),Vector(ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1)), ExplicitTerm(HyperTermId(50)), ExplicitTerm(HyperTermId(1))),EmptyMetadata))
    val rewriteRule = new PatternRewriteRule(conditions, destinations)
    val templateTermToHyperTermId: TemplateTerm[HyperTermId] => HyperTermId = PatternRewriteRulePropSpec.mapper(Stream.from(0).map(HyperTermId).iterator)
    val templateTermToHyperTermIdentifier: TemplateTerm[HyperTermIdentifier] => HyperTermIdentifier = PatternRewriteRulePropSpec.mapper(Stream.from(0).map(x => Identifier(x.toString)).map(HyperTermIdentifier).iterator)
    val state = mutable.CompactHyperGraph[HyperTermId, HyperTermIdentifier](conditions.map(edge => {
      HyperEdge[HyperTermId, HyperTermIdentifier](templateTermToHyperTermId(edge.target), templateTermToHyperTermIdentifier(edge.edgeType), edge.sources.map(templateTermToHyperTermId), EmptyMetadata)
    }).toSeq:_*)
    val tempProgs = Programs(state.clone)
    rewriteRule.apply(state)
    val expectedEdges = (destinations.edges -- conditions.edges).map(e => HyperEdge(e.target.asInstanceOf[ExplicitTerm[HyperTermId]].value, e.edgeType.asInstanceOf[ExplicitTerm[HyperTermIdentifier]].value, e.sources.map(_.asInstanceOf[ExplicitTerm[HyperTermId]].value), e.metadata))
    expectedEdges.size shouldEqual (state.edges -- tempProgs.queryGraph.edges).size
  }

}
